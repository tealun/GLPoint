{if !empty($data.fields)}
{if !empty($data.error) && is_string($data.error)}
{$data.error}
{/if}
<div class="woo-multiattr-container" data-max="{$data.attrs.max ?? 0}" data-delete-callback="{$data.multiattrs.delete_callback ?? ''}" data-clear-callback="{$data.multiattrs.clear_callback ?? ''}" data-insert-callback="{$data.multiattrs.insert_callback ?? ''}">
    {if empty($data.multiattrs.cancel_delete) || empty($data.multiattrs.cancel_clear)}
    <div style="padding-bottom: 15px;">
        {if empty($data.multiattrs.cancel_create)}
        <a class="layui-btn  javascript" rel="multiattrs_insert_row">新增</a>
        {/if}
        {if empty($data.multiattrs.cancel_clear)}
        <a class="layui-btn layui-btn-danger javascript multiattrs_clear" rel="together_clear">清空</a>
        {/if}
    </div>
    {/if}
    <input type="hidden" value="" name="{$data.attrs.name?:''}">
    <div class="woo-multiattr-table-box">
        <table class="layui-table woo-multiattr-table">
            <colgroup>
                {foreach $data.fields as $field => $item}
                {if $field != $data.together.pk}
                <col {if isset($item.width)}width="{$item.width}"{/if}>
                {/if}
                {/foreach}
                {if empty($data.multiattrs.cancel_delete) || empty($data.multiattrs.cancel_insert)}
                <col width="150">
                {/if}
            </colgroup>
            <thead>
            <tr>
                {foreach $data.fields as $field => $item}
                {if $field != $data.together.pk}
                <th>
                    {$item.label}
                    {if !empty($item.tip)}<div class="woo-form-item-tip woo-tiptool" data-tip-text="{$item.tip}" data-tip-bg="#FF5722" data-tip-type="3"><i class="woo-icon woo-icon-tishi"></i></div>{/if}
                </th>
                {/if}
                {/foreach}
                {if empty($data.multiattrs.cancel_delete) || empty($data.multiattrs.cancel_insert)}
                <th>操作</th>
                {/if}
            </tr>
            </thead>
            <tbody>
            {if !empty($data.attrs.value)}
            {if is_string($data.attrs.value) && is_json($data.attrs.value)}
            {assign name="$data.attrs.value" value=":json_decode($data.attrs.value,true)"/}
            {/if}
            {if !empty($data.error) && is_array($data.error)}
            {assign name="errors" value="$data.error"/}
            {else}
            {assign name="errors" value=":json_decode('[]',true)"/}
            {/if}
            <script>
                // 打印错误信息 可以F12查看分析
                console.log({:json_encode($errors)})
            </script>
            {if is_array($data.attrs.value)}
            {assign name="for_index" value="0" /}
            {foreach $data.attrs.value as $index => $row}
            <tr data-id="{$row[$data.together.pk] ?? ''}" data-model="{$data.together.foreign ?? ''}">
                {assign name="for_field_index" value="0" /}
                {foreach $data.fields as $field => $item}
                {if $field != $data.together.pk}
                <td>
                    {if $for_field_index == 0}
                    {assign name="pkItem" value="$data.fields[$data.together.pk]"/}
                    {if isset($row[$data.together.pk])}
                    {assign name="$pkItem.attrs.value" value="$row[$data.together.pk]"/}
                    {:str_replace('PLACEINDEX', $for_index,\\woo\\common\\builder\\Form::renderHtml($pkItem))}
                    {else /}
                    {:str_replace('PLACEINDEX', $for_index, $pkItem.html)}
                    {/if}
                    {/if}

                    {if isset($row[$field])}
                    {assign name="$item.attrs.value" value="$row[$field]"/}
                    {:str_replace('PLACEINDEX', $for_index,\\woo\\common\\builder\\Form::renderHtml($item))}
                    {else /}
                    {:str_replace('PLACEINDEX', $for_index, $item.html)}
                    {/if}
                    {if $errors && isset($errors[$index]) && isset($errors[$index][$field])}
                    <div class="error">{$errors[$index][$field]}</div>
                    {/if}
                </td>
                {assign name="for_field_index" value="$for_field_index+1" /}
                {/if}
                {/foreach}
                {if empty($data.multiattrs.cancel_delete) || empty($data.multiattrs.cancel_insert)}
                <td align="center">
                    {if empty($data.multiattrs.cancel_delete)}
                    <a class="layui-btn layui-btn-sm btn-25 javascript tooltip" data-tip-text="删除" rel="together_delete_row"><i class="layui-icon layui-icon-reduce-circle"></i></a>
                    {/if}
                    {if empty($data.multiattrs.cancel_insert)}
                    <a class="layui-btn  btn-22 layui-btn-sm javascript tooltip" data-tip-text="插入" rel="multiattrs_insert_row"><i class="layui-icon layui-icon-add-circle"></i></a>
                    {/if}
                </td>
                {/if}
            </tr>
            {assign name="for_index" value="$for_index+1" /}
            {/foreach}
            {/if}
            {/if}
            </tbody>
        </table>
    </div>
    <script type="text/html" class="multiattrs_demo">
        <tr data-id="" data-model="{$data.together.foreign ?? ''}">
            {assign name="for_field_index" value="0" /}
            {foreach $data.fields as $field => $item}
            {if $field != $data.together.pk}
            <td>
                {if $for_field_index == 0}
                {assign name="pkItem" value="$data.fields[$data.together.pk]"/}
                {assign name="$pkItem.attrs.value" value=""/}
                {:str_replace('PLACEINDEX', 0, \\woo\\common\\builder\\Form::renderHtml($pkItem))}
                {/if}

                {assign name="$item.attrs.value" value=""/}
                {:str_replace('PLACEINDEX', 0,\\woo\\common\\builder\\Form::renderHtml($item))}
            </td>
            {assign name="for_field_index" value="$for_field_index+1" /}
            {/if}
            {/foreach}
            {if empty($data.multiattrs.cancel_delete) || empty($data.multiattrs.cancel_insert)}
            <td align="center">
                {if empty($data.multiattrs.cancel_delete)}
                <a class="layui-btn layui-btn-sm btn-25 javascript tooltip" data-tip-text="删除" rel="together_delete_row"><i class="layui-icon layui-icon-reduce-circle"></i></a>
                {/if}
                {if empty($data.multiattrs.cancel_insert)}
                <a class="layui-btn btn-22 layui-btn-sm javascript tooltip" data-tip-text="插入" rel="multiattrs_insert_row"><i class="layui-icon layui-icon-add-circle"></i></a>
                {/if}
            </td>
            {/if}
        </tr>
    </script>
</div>
{else /}
未定义表单项"fields"属性
{/if}