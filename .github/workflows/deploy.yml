name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨

on:
  push:
    branches:
      - main  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½® PHP ç¯å¢ƒ
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, pdo_mysql, redis
          coverage: none

      - name: å®‰è£… Composer ä¾èµ–
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      - name: å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          # æ‰“åŒ…æ–‡ä»¶ï¼ˆæ’é™¤ä¸éœ€è¦çš„ï¼‰
          tar -czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env.example' \
            --exclude='README.md' \
            --exclude='docs' \
            --exclude='deploy.tar.gz' \
            --exclude='.env' \
            --exclude='runtime/*' \
            --exclude='public/uploads/*' \
            . || true

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # è®¾ç½®å˜é‡
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
            BACKUP_DIR="${{ secrets.BACKUP_DIR }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "====== å¼€å§‹éƒ¨ç½² ======"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            
            # 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
            echo "1. å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            mkdir -p $BACKUP_DIR
            if [ -d "$PROJECT_DIR" ]; then
              tar -czf $BACKUP_DIR/glpoint_$TIMESTAMP.tar.gz -C $PROJECT_DIR .
              echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR/glpoint_$TIMESTAMP.tar.gz"
            fi
            
            # 2. åˆ›å»ºä¸´æ—¶ç›®å½•
            echo "2. åˆ›å»ºä¸´æ—¶ç›®å½•..."
            TEMP_DIR="/tmp/glpoint_deploy_$TIMESTAMP"
            mkdir -p $TEMP_DIR
            
            # 3. ç¡®ä¿é¡¹ç›®ç›®å½•å­˜åœ¨
            mkdir -p $PROJECT_DIR
            
            # 4. å¤‡ä»½é…ç½®æ–‡ä»¶
            echo "3. å¤‡ä»½é…ç½®æ–‡ä»¶..."
            if [ -f "$PROJECT_DIR/.env" ]; then
              cp $PROJECT_DIR/.env $TEMP_DIR/.env.backup
            fi
            if [ -d "$PROJECT_DIR/public/uploads" ]; then
              cp -r $PROJECT_DIR/public/uploads $TEMP_DIR/uploads_backup
            fi
            if [ -d "$PROJECT_DIR/runtime" ]; then
              cp -r $PROJECT_DIR/runtime $TEMP_DIR/runtime_backup
            fi

      - name: ä¸Šä¼ éƒ¨ç½²åŒ…
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # è®¾ç½®å˜é‡
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            TEMP_DIR="/tmp/glpoint_deploy_$TIMESTAMP"
            
            # 5. è§£å‹æ–°ä»£ç 
            echo "4. è§£å‹æ–°ä»£ç ..."
            cd $PROJECT_DIR
            tar -xzf /tmp/deploy.tar.gz
            
            # 6. æ¢å¤é…ç½®æ–‡ä»¶
            echo "5. æ¢å¤é…ç½®æ–‡ä»¶..."
            if [ -f "$TEMP_DIR/.env.backup" ]; then
              cp $TEMP_DIR/.env.backup $PROJECT_DIR/.env
              echo ".env å·²æ¢å¤"
            fi
            
            if [ -d "$TEMP_DIR/uploads_backup" ]; then
              rm -rf $PROJECT_DIR/public/uploads
              cp -r $TEMP_DIR/uploads_backup $PROJECT_DIR/public/uploads
              echo "uploads ç›®å½•å·²æ¢å¤"
            fi
            
            if [ -d "$TEMP_DIR/runtime_backup" ]; then
              rm -rf $PROJECT_DIR/runtime
              cp -r $TEMP_DIR/runtime_backup $PROJECT_DIR/runtime
              echo "runtime ç›®å½•å·²æ¢å¤"
            fi
            
            # 7. è®¾ç½®æƒé™
            echo "6. è®¾ç½®æƒé™..."
            chown -R ${{ secrets.WEB_USER || 'www' }}:${{ secrets.WEB_USER || 'www' }} $PROJECT_DIR
            chmod -R 755 $PROJECT_DIR
            chmod -R 777 $PROJECT_DIR/runtime
            chmod -R 777 $PROJECT_DIR/public/uploads
            
            # 8. æ¸…ç†ç¼“å­˜
            echo "7. æ¸…ç†ç¼“å­˜..."
            cd $PROJECT_DIR
            php think clear
            php think optimize:route
            php think optimize:schema
            
            # 9. é‡å¯æœåŠ¡
            echo "8. é‡å¯ PHP-FPM..."
            systemctl restart php-fpm || service php-fpm restart
            
            # 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            echo "9. æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -f /tmp/deploy.tar.gz
            rm -rf $TEMP_DIR
            
            echo "====== éƒ¨ç½²å®Œæˆ ======"
            echo "ç‰ˆæœ¬: $(cd $PROJECT_DIR && git log -1 --format='%H %s')"

      # - name: å¥åº·æ£€æŸ¥
      #   run: |
      #     echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
      #     HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.API_URL }}/api/index/index)
      #     if [ $HTTP_CODE -eq 200 ]; then
      #       echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (HTTP $HTTP_CODE)"
      #     else
      #       echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $HTTP_CODE)"
      #       exit 1
      #     fi

      # - name: å‘é€éƒ¨ç½²é€šçŸ¥
      #   if: always()
      #   uses: appleboy/telegram-action@master
      #   with:
      #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
      #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      #     message: |
      #       ğŸš€ GLpoint éƒ¨ç½²å®Œæˆ
      #       
      #       ä»“åº“: ${{ github.repository }}
      #       åˆ†æ”¯: ${{ github.ref }}
      #       æäº¤: ${{ github.sha }}
      #       ä½œè€…: ${{ github.actor }}
      #       çŠ¶æ€: ${{ job.status }}
      #       
      #       æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
