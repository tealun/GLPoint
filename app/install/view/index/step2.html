{extend name="global"/}
{block name="content"}
<div class="steps">
    <ul class="grid">
        <li class="current">
            <span class="step">1</span>检测环境
        </li>
        <li>
            <span class="step">2</span>验证信息
        </li>
        <li>
            <span class="step">3</span>数据安装
        </li>
        <li>
            <span class="step">4</span>完成安装
        </li>
    </ul>
</div>
<div class="server">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <th width="25%">环境检测</th>
            <th width="25%">推荐配置</th>
            <th width="25%">当前状态</th>
            <th>最低要求</th>
        </tr>
        {foreach $env as $item}
        {if isset($item.is_title)}
        <tr>
            <th width="100%" colspan="4">{$item.title}</th>
        </tr>
        {/if}
        <tr {if isset($item.id)}id="{$item.id}"{/if}>
        <td>{$item[1] ?? ''}
            {if isset($item.link)}
            <a href="{$item.link}" target="_blank"><i class="layui-icon layui-icon-help"></i></a>
            {/if}
        </td>
        <td>{$item[2]??''}</td>
        <td>
            {if isset($item[3])}
                {if $item[3]}
                <i class="layui-icon layui-icon-ok"></i>
                {else}
                <i class="layui-icon layui-icon-close"></i>
                {/if}
            {/if}
            {$item[4] ?? ''}</td>
        <td>{$item[5] ?? ''}</td>
        </tr>
        {/foreach}
    </table>

    <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <th width="50%">目录、文件权限检查</th>
            <th>写入</th>
            <th>读取</th>
        </tr>
        {foreach $fresult as $dir => $item}
        <tr {if isset($item.id)}id="{$item.id}"{/if}>
        <td>{$dir}</td>
        <td>{if $item.w}<i class="layui-icon layui-icon-ok"></i> 可写{else}<i class="layui-icon layui-icon-close"></i> 不可写{/if}</td>
        <td>{if $item.r}<i class="layui-icon layui-icon-ok"></i> 可读{else}<i class="layui-icon layui-icon-close"></i> 不可读{/if}</td>
        </tr>
        {/foreach}
    </table>
</div>

<div class="bottom-btns">
    <a href="{$root}?s=install/index/step2" class="layui-btn">重新检测</a><a href="{:url('step3')}" class="layui-btn" onclick="return checkError()">下一步 >></a>
</div>
{/block}
{block name="script"}
<script>
    var error_count = {$error_count+1};
    function layuiReady() {
        $.ajax({
            url: "{:url('install/Index/testRewrite')}",
            type: 'GET',
            dataType: 'JSON',
            success: function (data) {
                if (data.result == 'success') {
                    error_count--;
                    $('#rewrite').find('td:eq(2)').html('<i class="layui-icon layui-icon-ok"></i> 已开启');
                } else {
                    $('#rewrite').find('td:eq(2)').html('<i class="layui-icon layui-icon-close"></i> 失败，请console中查看');
                    console.log('URL重写开启，但路由解析失败，根据经验请分别尝试下面情况处理；');
                    console.log('1、请务必确保域名绑定到public目录下，而非项目根目录');
                    console.log('2、Nginx服务器即使是本地开发，也建议采用绑定域名的方式开发，域名绑定到public下');
                    console.log('3、Nginx服务器请确定是否配置URL重写，规则：https://www.kancloud.cn/manual/thinkphp5/177576');
                    console.log('4、Apache服务器尝试更换“public/.htaccess”文件中另外一种URL重写规则');
                    console.log('5、清空runtime目录');
                }
            },
            error: function () {
                $('#rewrite').find('td:eq(2)').html('<i class="layui-icon layui-icon-close"></i> 未开启');
            }
        })
    }
    function checkError()
    {
        if (error_count > 0) {
            layer.alert('请先处理检测不通过的环境', {
                icon : 2
            });
            return false;
        } else {
            return true;
        }
    }
</script>
{/block}